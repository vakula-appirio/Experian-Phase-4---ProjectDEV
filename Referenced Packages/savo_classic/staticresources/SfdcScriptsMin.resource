$(document).ready(function(){$("div[data-post]").each(function(e,t){var n=new Savo.Classic.CreatePostViewModel($(t).data("id"),$(t).data("title"));n.GetPost();ko.applyBindings(n,t)});$("div[data-list]").each(function(e,t){var n=new Savo.Classic.CreateListViewModel($(t).data("criteria"),$(t).data("tags"),$(t).data("library-ids"),$(t).data("asset-types"),$(t).data("num-results"),$(t).data("record-downloads"),$(t).data("open-in-tab"),$(t).data("place-holder"));if($(t).data("default-load")==true){n.GetDocuments()}ko.applyBindings(n,t)})});(function(e){e.ShowLoading=function(e,t){var n=document.createElement("img");n.setAttribute("src",t);n.setAttribute("id","loadingImage");n.setAttribute("alt","No Image");n.setAttribute("height","25");n.setAttribute("width","25");e.appendChild(n)};e.HideLoading=function(){var e=document.getElementById("loadingImage");e.parentNode.removeChild(e)};e.ImageLoadError=function(e){e.src=e.src};e.LoadingImagePath=function(e){n=e};e.DefaultUserImagePath=function(e){t=e};e.SessionId=function(t){e.sessionId=t};e.PartnerUrl=function(t){e.partnerUrl=t};e.Encode=function(e){var t=e;if(t!=null&&t!=""){t=t.replace(",","%2c");t=t.replace("&","%26")}return t};e.GetUserImage=function(e){return sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiPreviewRepository","GetUserImageUrl",{userId:e})};e.GetDocumentMetaData=function(t){e.ShowLoading(document.getElementById("loadingPopUp"),n);var r=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiDocumentRepository","GetProperties",{documentId:t});var i=JSON.parse(r);e.HideLoading();return i};e.GetMultimediaDocumentPreviewImage=function(e){return e[6].Url};e.GetDocumentPreviewImage=function(e,t){if(t.length>0){var n=t[0].Id;var r=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiPreviewRepository","GetImageUrl",{documentId:e,documentPreviewId:n,previewType:"thumbnail"});return r}else return""};e.PopUpPaginationNext=function(e){var t=document.getElementById("currentpreview");var n=parseInt(t.innerHTML);var r=document.getElementById("previewLength");var i=parseInt(r.innerHTML);if(n<i){var s=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiDocumentRepository","GetProperties",{documentId:e});var o=JSON.parse(s);var u=o.Previews;var a=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiPreviewRepository","GetImageUrl",{documentId:e,documentPreviewId:u[n].Id,previewType:"thumbnail"});t.innerHTML=n+1;var f=document.getElementById("thumbnailPreview");f.src=a;$("a#popupPrevBtn").css("cursor","pointer").css("color","#333333")}if(n+1<i){$("a#popupNextBtn").css("cursor","pointer").css("color","#333333")}else{$("a#popupNextBtn").css("cursor","default").css("color","#999")}};e.PopUpPaginationPrevious=function(e){var t=document.getElementById("currentpreview");var n=parseInt(t.innerHTML);if(n>1){var r=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiDocumentRepository","GetProperties",{documentId:e});var i=JSON.parse(r);var s=i.Previews;var o=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiPreviewRepository","GetImageUrl",{documentId:e,documentPreviewId:s[n-2].Id,previewType:"thumbnail"});var u=document.getElementById("thumbnailPreview");u.src=o;t.innerHTML=n-1;$("a#popupNextBtn").css("cursor","pointer").css("color","#333333")}if(n-1>1){$("a#popupPrevBtn").css("cursor","pointer").css("color","#333333")}else{$("a#popupPrevBtn").css("cursor","default").css("color","#999")}};e.Download=function(t,n){var r=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiDocumentRepository","Download",{documentId:t});var i;var s="hiddenDownloader";i=document.getElementById(s);if(i===null){i=document.createElement("iframe");i.id=s;i.style.display="none";document.body.appendChild(i)}i.src=r;if(n==true){var u=Savo.Classic.GetDocumentMetaData(t);e.LogActivityHistory(u.Title+" was downloaded (Asset ID: "+t+")",o)}};e.LogActivityHistory=function(e,t){var n=new sforce.SObject("Task");n.Subject=e;n.OwnerId=r;n.Status="Completed";n.ActivityDate=new Date;n.WhatId=t;n.WhoId="";var i=sforce.connection.create([n]);if(i[0].success=="false"&&i[0].errors.statusCode=="FIELD_INTEGRITY_EXCEPTION"){n.WhoId=t;n.WhatId="";var i=sforce.connection.create([n])}};e.SetSFDCUserId=function(e){r=e};e.SetAccountId=function(e){o=e};e.GetUrl=function(e,t){if(t==true){this.redirectToSavoTab("&returnurl="+e)}else window.open(this.BuildLink("returnurl="+this.Encode(e)))};e.redirectToUrl=function(e,t){e=this.GetSavoUrl()+e;if(t==true){this.redirectToSavoTab("&returnurl="+this.Encode(e))}else window.open(this.BuildLink("returnurl="+this.Encode(e)))};e.redirectToTarget=function(e,t,n){var r="";if(e.toLowerCase()=="platform")r="&returnurl="+t;else r="&redirectParameter="+t;if(n==true){this.redirectToSavoTab("&redirecttarget="+e+r)}else window.open(this.BuildLink("redirecttarget="+e+r))};e.redirectToSavoTab=function(e){var t=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiHeaderRepository","GetSavoTabUrl",{});var n=this.Encode(t+"&sessionid="+Savo.Classic.sessionId+"&url="+Savo.Classic.partnerUrl+e);window.open(n)};e.GetSavoUrl=function(){var e=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiHeaderRepository","GetSavoAPIUrl",{}).toString();var t=e.substring(e.indexOf("https"),e.indexOf("com"))+"com/";return t.replace("api","www")};e.BuildLink=function(e){var t=e.substring(e.indexOf("https"),e.indexOf("com"))+"com";if(t=="com")t=this.GetSavoUrl();var n=t+"/SingleSignOn/Salesforce.ashx?sessionid="+Savo.Classic.sessionId+"&url="+Savo.Classic.partnerUrl;if(e!==null){n=n+"&"+e}return n};e.SetDefaultUser=function(e){e.src=t};e.CreateProductDropDown=function(t,n){var r=sforce.connection.query("SELECT Id, Name, (SELECT UnitPrice, PricebookEntry.Name FROM OpportunityLineItems) FROM Opportunity WHERE Id ='"+t+"'");var i=r.getArray("records");var s=i[0];if(s.OpportunityLineItems===null){e.CreateDropdown(n)}else{var o=new Array;if(s.OpportunityLineItems.size<=1){o[0]=s.OpportunityLineItems.records.PricebookEntry.Name}else{for(var u=0;u<s.OpportunityLineItems.size;u++){o[u]=s.OpportunityLineItems.records[u].PricebookEntry.Name}}e.CreateDropdown(n,o)}};e.CreateDropdown=function(e,t){if(t===undefined||t.length===0){document.write('<select id="'+e+'"  disabled="disabled">')}else{document.write('<select id="'+e+'" > ');for(var n=0;n<t.length;n++){document.write('<option value="'+t[n]+'">'+t[n]+"</option>")}}document.write("</select>")};e.GetPackageName=function(){return"savo_classic/"};e.CreatePostViewModel=function(e,t){var n={widgetHeader:ko.observable(""),postId:ko.observable(e),postTitle:ko.observable(""),postContent:ko.observable(""),isPostLoading:ko.observable(true),defaultTitle:ko.observable("")};if(t!=null)n.defaultTitle(t.trim());n.GetPost=function(){try{this.isPostLoading(true);var e=parseInt(this.postId());var t={onSuccess:this.handleSuccess,onFailure:this.handleFailure,source:this};sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiPostRepository","Get",{postId:e},t)}catch(n){this.Title("This Post cannot be displayed at this time.")}};n.handleSuccess=function(e,t){var n=JSON.parse(e);if(n.StatusCode!=null){throw"Error In API - StatusCode : "+n.StatusCode}else{t.postContent(n.Content[0].Value);if(t.defaultTitle().length==0){t.postTitle("");t.widgetHeader(n.Title)}else{t.postTitle(n.Title);t.widgetHeader(t.defaultTitle())}}t.isPostLoading(false)};n.handleFailure=function(e,t){t.widgetHeader(t.defaultTitle());t.postTitle("This Post cannot be displayed at this time.");t.postContent("");t.isPostLoading(false)};return n};e.CreateListViewModel=function(t,n,r,s,o,u,a,f){var l={assets:ko.observableArray(null),pageSize:ko.observable(10),pageIndex:ko.observable(1),maxPageIndex:ko.observable(0),startPageIndex:ko.observable(1),lastPageIndex:ko.observable(1),totalAssets:ko.observable(0),isListLoading:ko.observable(false),APIError:ko.observable(""),isLoadFirstTime:ko.observable(true),criteria:ko.observable((t||"").trim()),tags:ko.observable(""),libraryIds:ko.observable(""),assetTypes:ko.observable(""),recordDownloads:ko.observable(false),openInTab:ko.observable(false),placeHolder:ko.observable("Search Savo...")};u=u.toString().toLowerCase();if(u===true.toString()||u===false.toString())l.recordDownloads(u);if(f!=null&&f.trim().length!=0){l.placeHolder(f.trim())}a=a.toString().toLowerCase();if(a===true.toString()||a===false.toString())l.openInTab(a);l.assets(null);if(parseInt(o)>=1)l.pageSize(parseInt(o));l.tags(n);l.libraryIds(r);l.assetTypes(s);l.SearchOnKeyPress=function(e,t){this.Refresh()};l.GetDocuments=function(){this.assets(null);this.totalAssets(0);this.APIError("");this.isLoadFirstTime(false);try{this.isListLoading(true);var e=escape(this.criteria());var t=this.pageSize();var n=this.libraryIds();var r=escape(this.tags());var i=this.assetTypes();var s=this.pageIndex();var o={onSuccess:this.HandleSuccess,onFailure:this.HandleFailure,source:this};var u=sforce.apex.execute(Savo.Classic.GetPackageName()+"ApiSearchRepository","Search",{searchQuery:e,libraryIds:n,tags:r,assetTypes:i,startPage:s,numResults:t},o)}catch(a){document.write(a)}};l.HandleSuccess=function(e,t){var n=JSON.parse(e);if(n.StatusCode!=null){throw"Error In API- Status Code : "+n.StatusCode}else{var r=parseInt(n.totalResults/n.itemsPerPage);if(n.totalResults%n.itemsPerPage>0)r+=1;var i=n.itemsPerPage;t.maxPageIndex(r);t.totalAssets(n.totalResults);t.APIError("");jDocument=n;t.assets(t.GetAssets(jDocument,t));t.isListLoading(false);if(jDocument.totalResults==0){t.assets(null)}}};l.HandleFailure=function(e,t){t.assets(null);t.totalAssets(0);t.isListLoading(false)};l.NextPage=function(){if(this.pageIndex()<this.maxPageIndex()){this.pageIndex(this.pageIndex()+1);this.GetDocuments()}};l.Refresh=function(){this.startPageIndex(1);this.pageIndex(1);this.GetDocuments()};l.PreviousPage=function(){if(this.pageIndex()>1){this.pageIndex(this.pageIndex()-1);this.GetDocuments()}};l.MoveToPage=function(e){if(e!=this.pageIndex()){this.pageIndex(e);this.GetDocuments()}};l.viewStatus=ko.computed(function(){var e="";if(this.assets()!=null){e="viewing "+(1+(this.pageIndex()-1)*this.pageSize())+" to "+Math.min(this.pageIndex()*this.pageSize(),this.totalAssets())+" of "+this.totalAssets()+" assets"}return e},l);l.allPages=ko.dependentObservable(function(){var e=[];if(this.totalAssets()>0){var t=10;if(this.maxPageIndex()<t&&this.maxPageIndex()>0)t=this.maxPageIndex();if(this.pageIndex()==this.lastPageIndex()+1&&this.pageIndex()<=this.maxPageIndex()){this.startPageIndex(this.pageIndex());this.lastPageIndex(this.pageIndex()+(t-1));if(this.lastPageIndex()>this.maxPageIndex())this.lastPageIndex(this.maxPageIndex())}else if(this.pageIndex()==this.startPageIndex()-1&&this.pageIndex()!=0){this.startPageIndex(this.startPageIndex()-t);this.lastPageIndex(this.startPageIndex()+(t-1));if(this.lastPageIndex()>this.maxPageIndex())this.lastPageIndex(this.maxPageIndex())}if(this.startPageIndex()==1)this.lastPageIndex(t);for(i=this.startPageIndex();i<=this.lastPageIndex();i++){e.push({pageNumber:i})}}return e},l);l.Asset=function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p=this;p.Id=e;p.title=t;p.type=n;p.owner=r;p.createdDate=i;p.modifiedDate=s;p.averageRating=o;p.isDownloadable=u;p.isAsset=a;p.userUrl=f;p.UrlToView=l;p.isComment=c};l.GetAssets=function(t,n){var r=new Array;for(var i=0;i<t.Items.length;i++){if(t.Items[i].Asset!=null){if(t.Items[i].Asset.Document!=null){r.push(new this.Asset(t.Items[i].Asset.Document.Id,""+t.Items[i].Asset.Document.Title,""+t.Items[i].Asset.Document.DocType,""+t.Items[i].Asset.Document.Owner.DisplayName,""+t.Items[i].Asset.Document.CreatedDate,""+t.Items[i].Asset.Document.ModifiedDate,""+t.Items[i].Asset.Document.AverageRating,true,true,"",t.Items[i].Asset.Document.UrlToView,false))}else if(t.Items[i].Asset.Post!=null){r.push(new this.Asset(t.Items[i].Asset.Post.Id,""+t.Items[i].Asset.Post.Title,"post",""+t.Items[i].Asset.Post.Owner.DisplayName,""+t.Items[i].Asset.Post.CreatedDate,""+t.Items[i].Asset.Post.ModifiedDate,""+t.Items[i].Asset.Post.AverageRating,false,true,"",t.Items[i].Asset.Post.UrlToView,false))}else if(t.Items[i].Asset.CustomPage!=null){r.push(new this.Asset(t.Items[i].Asset.CustomPage.Id,""+t.Items[i].Asset.CustomPage.Title,"custompage",""+t.Items[i].Asset.CustomPage.Owner.DisplayName,""+t.Items[i].Asset.CustomPage.CreatedDate,""+t.Items[i].Asset.CustomPage.ModifiedDate,""+t.Items[i].Asset.CustomPage.AverageRating,false,true,"",t.Items[i].Asset.CustomPage.UrlToView,false))}else if(t.Items[i].Asset.Question!=null){r.push(new this.Asset(t.Items[i].Asset.Question.Id,""+t.Items[i].Asset.Question.Title,"Question",""+t.Items[i].Asset.Question.Owner.DisplayName,""+t.Items[i].Asset.Question.CreatedDate,""+t.Items[i].Asset.Question.ModifiedDate,""+t.Items[i].Asset.Question.AverageRating,false,true,"",t.Items[i].Asset.Question.UrlToView,false))}}else if(t.Items[i].User!=null){r.push(new this.Asset(t.Items[i].User.Id,""+t.Items[i].User.DisplayName,"User",""+t.Items[i].User.Title,"","","",false,false,e.GetUserImage(t.Items[i].User.Id),t.Items[i].User.UrlToView,false))}else if(t.Items[i].Comment!=null){r.push(new this.Asset(t.Items[i].Comment.Id,""+t.Items[i].Comment.Body,"Comment",""+t.Items[i].Comment.Creator.Email,""+t.Items[i].Comment.CreatedDate,""+t.Items[i].Comment.ModifiedDate,"",false,false,"","",true))}}return r};return l};e.sessionId;e.partnerUrl;var t;var n;var r;var s;var o})((window.Savo=window.Savo||{},window.Savo.Classic=window.Savo.Classic||{}));ko.bindingHandlers.enterKey={init:function(e,t,n,r){ko.utils.registerEventHandler(e,"keyup",function(n){if(n.keyCode===13){ko.utils.triggerEvent(e,"change");t().call(r,r)}})}};$(function(){var e=10;var t=5;var n=195;var r=400;$("dd[data-popUp]").each(function(e,t){if(e>0)$(t).remove()});$("a#trigger").live("click",function(i){$("dd[data-popUp]").empty();$("div[data-popUpDetails]").remove();$("dd[data-popUp]").append("<div id='loadingPopUp'></div>");var s=i.pageX;var o=i.pageY;var u=$(document).width();var a=$(document).height();var f=s+e+r;var l=o+t+n;if(f>u){s=s-e-(f-u)}else{s=s+e}if(l>a){o=o-t-(l-a)}else{o=o+t}$("dd#pop-up").show().css("top",o).css("left",s).appendTo("body");var c=Savo.Classic.GetDocumentMetaData($(this).data("id"));var h=$(this).data("record-history");var p="<div data-popUpDetails>";p=p+"<h3>"+c.Title+"</h3>";p=p+'<div class="content">';p=p+'<div id="loadThumbnail" class="left">';if(c.Previews.length>0){p=p+'<img id="thumbnailPreview" src="'+Savo.Classic.GetDocumentPreviewImage(c.Id,c.Previews)+'" alt="Please wait..." width="140px" height="105px" onerror="Savo.Classic.ImageLoadError(this)">';if(c.Previews.length>1){p=p+'<p align="center"><a id="popupPrevBtn" href="javascript:Savo.Classic.PopUpPaginationPrevious('+c.Id+');" style="color: #999;font-weight: bold;cursor: default;text-decoration: none"><span class="arrow-left"></span> Prev  </a>';p=p+'<span id="currentpreview" style="color:#333333;">1</span> <span style="color:#333333;">of</span> <span id="previewLength" style="color:#333333;"> '+c.Previews.length+"</span>";p=p+'<a id="popupNextBtn" href="javascript:Savo.Classic.PopUpPaginationNext('+c.Id+');" style="color: #999;font-weight: bold;cursor: default;text-decoration: none">  Next <span class="arrow-right"></span></div></a></p>'}}else if(c.Previews.length==0&&c.MultimediaUrls.length==7){p=p+'<img id="thumbnailPreview" src="'+Savo.Classic.GetMultimediaDocumentPreviewImage(c.MultimediaUrls)+'" alt="Please wait..." width="140px" height="105px" onerror="Savo.Classic.ImageLoadError(this)">'}else if(c.Previews.length==0&&c.MultimediaUrls.length==1){p=p+'<span id="thumbnailPreview" class="icon mmaudio"/>'}p=p+"</div>";p=p+"</div>";p=p+'<div class="right">';p=p+"<ul>";p=p+"<li>By "+c.Owner.DisplayName+"</li>";p=p+"<li>Modified: "+c.CreatedDate+"</li>";p=p+"<li>Created: "+c.ModifiedDate+"</li>";p=p+"<li>Size: "+Math.round(c.FileSize/1024)+" KB , "+c.Previews.length+" Slides</li>";p=p+"<li>Rating: "+c.AverageRating+" stars</li>";p=p+'<li><a id="download" href="javascript:Savo.Classic.Download('+c.Id+","+h+');">Download</a></li>';p=p+"</ul>";p=p+"</div>";p=p+"</div>";p=p+"</div>";$("dd[data-popUp]").append(p);if(c.Previews.length>1)$("a#popupNextBtn").css("cursor","pointer").css("color","#333333");$("dd#pop-up").focus()});$(document).mouseup(function(e){var t=$("dd#pop-up");if(t.length>0){if(t.has(e.target).length===0){t.hide()}}})})